<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∏–∫–µ—Ä: –†–æ—Å—Å–∏—è vs –£–∫—Ä–∞–∏–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 10px; text-align: center; }
        button { padding: 12px 20px; margin: 5px; background: #0088cc; color: white; border: none; border-radius: 5px; }
        .stats {
            margin: 15px auto;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            max-width: 300px;
        }
        .online { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!userCountry">
            <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</h1>
            <button @click="selectCountry('Russia')">üá∑üá∫ –†–æ—Å—Å–∏—è</button>
            <button @click="selectCountry('Ukraine')">üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞</button>
        </div>
        <div v-else>
            <h1>–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞: {{ userCountry }}</h1>
            <button @click="addClick">–ö–õ–ò–ö ({{ userClicks }})</button>

            <div class="stats">
                <h2>–û–±—â–∏–π —Å—á—ë—Ç</h2>
                <div>üá∑üá∫ –†–æ—Å—Å–∏—è: {{ countryScores.Russia || 0 }}</div>
                <div>üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞: {{ countryScores.Ukraine || 0 }}</div>

                <h2>–í–∞—à–∏ –∫–ª–∏–∫–∏: {{ userClicks }}</h2>

                <div class="online">–ò–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω: {{ onlineCount }}</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–∑–∞–º–µ–Ω–∏—Ç–µ —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏)
        const firebaseConfig = {
          apiKey: "AIzaSyCM_mQULdndLnXTXmjvWMM1u1jY3619fXc",
          authDomain: "my-miniapp-e609e.firebaseapp.com",
          projectId: "my-miniapp-e609e",
          databaseURL: "https://my-miniapp-e609e-default-rtdb.europe-west1.firebasedatabase.app/",
          storageBucket: "my-miniapp-e609e.firebasestorage.app",
          messagingSenderId: "791995427739",
          appId: "1:791995427739:web:cbe22b29ddfea2b4a70f3e",
          measurementId: "G-R1K9ZJD59Y"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω!");

        const { createApp, ref, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                const tg = window.Telegram.WebApp;
                const userId = tg.initDataUnsafe.user?.id || Date.now(); // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userCountry = ref(null);
                const userClicks = ref(0);
                const countryScores = ref({ Russia: 0, Ukraine: 0 });
                const onlineCount = ref(0);
                const userRef = firebase.database().ref('users/' + userId);
                const onlineRef = firebase.database().ref('online/' + userId);
                const connectionsRef = firebase.database().ref('.info/connected');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                onMounted(() => {
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—â–∏—Ö —Å—á–µ—Ç–æ–≤
                    firebase.database().ref('countryScores').on('value', (snapshot) => {
                        const data = snapshot.val() || { Russia: 0, Ukraine: 0 };
                        countryScores.value = data;
                    });

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
                    userRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            userClicks.value = data.clicks || 0;
                            userCountry.value = data.country;
                        }
                    });

                    // –ü–æ–¥—Å—á–µ—Ç –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä–æ–∫–æ–≤
                    firebase.database().ref('online').on('value', (snapshot) => {
                        onlineCount.value = snapshot.numChildren();
                    });

                    // –û—Ç–º–µ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –æ–Ω–ª–∞–π–Ω
                    connectionsRef.on('value', (snapshot) => {
                        if (snapshot.val()) {
                            onlineRef.set(true);
                            onlineRef.onDisconnect().remove();
                        }
                    });
                });

                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                onUnmounted(() => {
                    onlineRef.remove();
                });

                // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã
                const selectCountry = (country) => {
                    userCountry.value = country;
                    tg.expand();
                    userRef.update({
                        country: country,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                };

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
                const addClick = () => {
                    if (!userCountry.value) return;

                    userClicks.value++;
                    userRef.update({
                        clicks: userClicks.value,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });

                    firebase.database().ref('countryScores/' + userCountry.value)
                        .transaction((current) => (current || 0) + 1);
                };

                return {
                    userCountry,
                    userClicks,
                    countryScores,
                    onlineCount,
                    selectCountry,
                    addClick
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
