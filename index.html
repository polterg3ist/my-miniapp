<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∏–∫–µ—Ä: –†–æ—Å—Å–∏—è vs –£–∫—Ä–∞–∏–Ω–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }
        button {
            padding: 12px 20px;
            margin: 5px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        .stats {
            margin: 15px auto;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .online {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 10px;
        }
        .player-list {
            margin-top: 10px;
            text-align: left;
            padding: 0 10px;
        }
        .player-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!userCountry">
            <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</h1>
            <button @click="selectCountry('Russia')">üá∑üá∫ –†–æ—Å—Å–∏—è</button>
            <button @click="selectCountry('Ukraine')">üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞</button>
        </div>
        <div v-else>
            <h1>–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞: {{ userCountry }}</h1>
            <button @click="addClick">–ö–õ–ò–ö ({{ userClicks }})</button>

            <div class="stats">
                <h2>–û–±—â–∏–π —Å—á—ë—Ç</h2>
                <div>üá∑üá∫ –†–æ—Å—Å–∏—è: {{ countryScores.Russia || 0 }}</div>
                <div>üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞: {{ countryScores.Ukraine || 0 }}</div>

                <h2>–í–∞—à–∏ –∫–ª–∏–∫–∏: {{ userClicks }}</h2>

                <div class="online">–ò–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω: {{ onlineCount }}</div>

                <div class="player-list" v-if="onlineCount > 0">
                    <h3>–°–µ–π—á–∞—Å –∏–≥—Ä–∞—é—Ç:</h3>
                    <div class="player-item" v-for="(user, id) in onlinePlayers" :key="id">
                        {{ user.country === 'Russia' ? 'üá∑üá∫' : 'üá∫üá¶' }} –ò–≥—Ä–æ–∫ #{{ id.toString().slice(-4) }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCM_mQULdndLnXTXmjvWMM1u1jY3619fXc",
          authDomain: "my-miniapp-e609e.firebaseapp.com",
          projectId: "my-miniapp-e609e",
          databaseURL: "https://my-miniapp-e609e-default-rtdb.europe-west1.firebasedatabase.app/",
          storageBucket: "my-miniapp-e609e.firebasestorage.app",
          messagingSenderId: "791995427739",
          appId: "1:791995427739:web:cbe22b29ddfea2b4a70f3e",
          measurementId: "G-R1K9ZJD59Y"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω!");

        const { createApp, ref, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                const tg = window.Telegram.WebApp;
                const userId = tg.initDataUnsafe.user?.id || 'user_' + Math.random().toString(36).substr(2, 9);
                const userCountry = ref(null);
                const userClicks = ref(0);
                const countryScores = ref({ Russia: 0, Ukraine: 0 });
                const onlineCount = ref(0);
                const onlinePlayers = ref({});

                // –°—Å—ã–ª–∫–∏ –Ω–∞ Firebase
                const userRef = firebase.database().ref('users/' + userId);
                const onlineRef = firebase.database().ref('online/' + userId);
                const connectionsRef = firebase.database().ref('.info/connected');
                const onlineUsersRef = firebase.database().ref('onlineUsers');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                onMounted(() => {
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—â–∏—Ö —Å—á–µ—Ç–æ–≤
                    firebase.database().ref('countryScores').on('value', (snapshot) => {
                        countryScores.value = snapshot.val() || { Russia: 0, Ukraine: 0 };
                    });

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    userRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            userClicks.value = data.clicks || 0;
                            userCountry.value = data.country || null;
                        }
                    });

                    // –û—Ç–º–µ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞
                    connectionsRef.on('value', (snapshot) => {
                        if (snapshot.val()) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                            const updateStatus = () => {
                                userRef.update({
                                    lastActive: firebase.database.ServerValue.TIMESTAMP,
                                    country: userCountry.value
                                });
                                onlineRef.set(true);
                            };

                            updateStatus();
                            const interval = setInterval(updateStatus, 30000);

                            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
                            onlineRef.onDisconnect().remove();
                            userRef.onDisconnect().update({
                                lastActive: firebase.database.ServerValue.TIMESTAMP
                            });

                            // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                            onUnmounted(() => {
                                clearInterval(interval);
                            });
                        }
                    });

                    // –ü–æ–¥—Å—á–µ—Ç –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä–æ–∫–æ–≤
                    onlineUsersRef.on('value', (snapshot) => {
                        onlineCount.value = snapshot.numChildren();
                    });

                    // –°–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä–æ–∫–æ–≤
                    firebase.database().ref('users').orderByChild('lastActive').startAt(Date.now() - 60000).on('value', (snapshot) => {
                        const users = snapshot.val() || {};
                        const activePlayers = {};

                        Object.keys(users).forEach(id => {
                            if (users[id].lastActive > Date.now() - 60000) {
                                activePlayers[id] = {
                                    country: users[id].country || 'Unknown'
                                };
                            }
                        });

                        onlinePlayers.value = activePlayers;
                        onlineCount.value = Object.keys(activePlayers).length;
                    });
                });

                // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã
                const selectCountry = (country) => {
                    userCountry.value = country;
                    tg.expand();
                    userRef.update({
                        country: country,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                    onlineRef.set(true);
                };

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
                const addClick = () => {
                    if (!userCountry.value) return;

                    userClicks.value++;
                    userRef.update({
                        clicks: userClicks.value,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });

                    firebase.database().ref('countryScores/' + userCountry.value)
                        .transaction((current) => (current || 0) + 1);
                };

                return {
                    userCountry,
                    userClicks,
                    countryScores,
                    onlineCount,
                    onlinePlayers,
                    selectCountry,
                    addClick
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
